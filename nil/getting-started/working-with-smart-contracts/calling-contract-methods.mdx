import Tabs from '@theme/Tabs'
import TabItem from '@theme/TabItem'

# Calling methods inside smart contracts

This tutorial outlines how to interact with [**the tutorial smart contracts**](./writing-a-contract) given the developer tools provided by =nil;.

## Prerequisites

Complete the following tutorials before proceeding.

* [**Writing a contract**](./writing-a-contract)
* [**Deploying a contract**](./deploying-a-contract)

## Calling methods internally

### Via the =nil; CLI

To call the `orderProduct()` function inside the retailer contract and trigger an async call:

```bash
nil_cli wallet send-tokens RETAILER_ADDRESS 5000000
nil_cli wallet send-message RETAILER_ADDRESS orderProduct MANUFACTURER_ADDRESS new-product --abi path/to/Retailer.abi
```

To call the `getProduct()` function inside the manufacturer contract:

```bash
nil_cli wallet send-message MANUFACTURER_ADDRESS getProducts --abi path/to/Manufacturer.abi
```

Retrieve the message hash from the output and access the message:

```bash
nil_cli message MESSAGE_HASH
```

When decoded, the `"data"` field in the output should show the newly created product.

### Via the client library

To send funds to the retailer product and call the `orderProduct` method:

```ts showLineNumbers
const hashFunds = await faucet.withdrawToWithRetry(addressR, 5_000_000n);

await waitTillCompleted(client, 1, hashFunds);

const hashProduct = await wallet.sendMessage({
  to: addressR,
  data: encodeFunctionData({
    abi: RETAILER_ABI as Abi,
    functionName: "orderProduct",
    args: [addressM, "another-product"],
  }),
  gas: 100000n,
  value: 1000000n,
});

await waitTillCompleted(client, 1, hashProduct);

console.log("Product created!");
```

To receive the currently created products:

```ts showLineNumbers
const hashGetProduct = await wallet.sendMessage({
  to: addressM,
  data: encodeFunctionData({
    abi: MANUFACTURER_ABI as Abi,
    functionName: "getProducts",
    args: [],
  }),
  gas: 100000n,
  value: 1000000n,
});

await waitTillCompleted(client, 1, hashGetProduct);
console.log(`Final hash: ${hashGetProduct}`);

```


## Via the Hardhat plugin

Calling smart contract methods via the Hardhat plugin requires creating Hardhat tasks.

Setting the retailer contract address:

```typescript showLineNumbers
import { task } from "hardhat/config";

task("setRetailerContractAddress", "Sets the Retailer contract address")
  .addParam("retailer", "The address of the Retailer contract")
  .addParam("manufacturer", "The address of the Manufacturer contract")
  .setAction(async (taskArgs, hre) => {
    const Manufacturer = await hre.ethers.getContractFactory("Manufacturer");
    const manufacturer = Manufacturer.attach(taskArgs.manufacturer);

    console.log("Setting the retailer address...");
    const setterTx = await manufacturer.setRetailerContractAddress(taskArgs.retailer);
    await setterTx.wait(0);

    const currentAddress = await manufacturer.getRetailerContractAddress();
    console.log(`Retailer address: ${currentAddress}`);
  });
```

Ordering a product from the manufacturer:

```typescript showLineNumbers
import { task } from "hardhat/config";

task("orderProduct", "Orders a product")
  .addParam("retailer", "The address of the Retailer contract")
  .addParam("manufacturer", "The address of the Manufacturer contract")
  .addParam("product", "The name of the product")
  .setAction(async (taskArgs, hre) => {
    const Retailer = await hre.ethers.getContractFactory("Retailer");
    const retailer = Retailer.attach(taskArgs.retailer);

    console.log("Ordering the product...");
    const setterTx = await retailer.orderProduct(taskArgs.manufacturer, taskArgs.product);
    await setterTx.wait(0);
  });
```

Retrieving the currently ordered products:

```typescript showLineNumbers
import { task } from "hardhat/config";

task("getProducts", "Gets the current products")
  .addParam("manufacturer", "The address of the Manufacturer contract")
  .setAction(async (taskArgs, hre) => {
    const Manufacturer = await hre.ethers.getContractFactory("Manufacturer");
    const manufacturer = Manufacturer.attach(taskArgs.manufacturer);

    console.log("Getting products..");
    const products = await manufacturer.getProducts();

    console.log(products);

  });
```

Execute the following commands to run the newly created tasks:

```bash
npx hardhat setRetailerContractAddress --manufacturer MANUFACTURER_ADDRESS --retailer RETAILER_ADDRESS
```

```bash
npx hardhat orderProduct --manufacturer MANUFACTURER_ADDRESS --retailer RETAILER_ADDRESS --product PRODUCT_NAME
```

```bash
npx hardhat getProduct --manufacturer MANUFACTURER_ADDRESS --network nil_cluster
```

